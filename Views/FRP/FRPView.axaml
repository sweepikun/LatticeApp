<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Lattice.ViewModels"
             x:Class="Lattice.Views.FRP.FRPView"
             x:DataType="vm:FRPViewModel">
    
    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Padding="24,16" Background="{DynamicResource BackgroundBrush}">
            <TextBlock Text="内网穿透" Classes="title" VerticalAlignment="Center"/>
        </Border>

        <ScrollViewer Grid.Row="1">
            <StackPanel Margin="24" Spacing="16">
                <!-- Loading -->
                <ProgressBar IsIndeterminate="True" IsVisible="{Binding IsLoading}" Height="2"/>
                
                <!-- Error -->
                <Border Background="{DynamicResource StatusErrorBrush}" CornerRadius="8" Padding="16,12"
                        IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding ErrorMessage}" Foreground="White"/>
                </Border>

                <!-- Download FRP Section -->
                <Border Background="{DynamicResource CardBrush}" CornerRadius="8" Padding="20"
                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Border Width="48" Height="48" CornerRadius="8"
                                Background="{DynamicResource AccentSubtleBrush}">
                            <PathIcon Data="{StaticResource ArrowDownloadIcon}" Width="24" Height="24"
                                      Foreground="{DynamicResource AccentBrush}"/>
                        </Border>
                        <StackPanel Grid.Column="1" Margin="16,0,0,0" VerticalAlignment="Center">
                            <TextBlock Text="FRP 客户端" FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                            <TextBlock Text="下载并配置内网穿透客户端" FontSize="12"
                                       Foreground="{DynamicResource TextTertiaryBrush}"/>
                        </StackPanel>
                        <Button Grid.Column="2" Content="下载 FRP" Classes="accent"/>
                    </Grid>
                </Border>

                <!-- FRP Configuration -->
                <Border Background="{DynamicResource CardBrush}" CornerRadius="8" Padding="20"
                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                    <StackPanel Spacing="16">
                        <TextBlock Text="FRP 配置" Classes="subtitle"/>
                        
                        <Grid ColumnDefinitions="120,*">
                            <TextBlock Text="启用服务" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <ToggleSwitch Grid.Column="1" IsChecked="{Binding Enabled}"/>
                        </Grid>
                        
                        <Grid ColumnDefinitions="120,*">
                            <TextBlock Text="服务器地址" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Grid.Column="1" Text="{Binding ServerAddress}"
                                     Classes="input" Watermark="frp.example.com"/>
                        </Grid>
                        
                        <Grid ColumnDefinitions="120,*">
                            <TextBlock Text="服务器端口" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <NumericUpDown Grid.Column="1" Value="{Binding ServerPort}" 
                                          Minimum="1" Maximum="65535" Width="120" HorizontalAlignment="Left"/>
                        </Grid>
                        
                        <Button Content="保存配置" Command="{Binding SaveConfigCommand}"
                                Classes="accent" HorizontalAlignment="Left"/>
                    </StackPanel>
                </Border>

                <!-- Tunnels -->
                <Border Background="{DynamicResource CardBrush}" CornerRadius="8" Padding="20"
                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                    <StackPanel Spacing="16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="隧道管理" Classes="subtitle"/>
                            <Button Grid.Column="1" Command="{Binding ShowAddTunnelFormCommand}" Classes="accent"
                                    Height="32" Padding="12,0">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{StaticResource AddIcon}" Width="14" Height="14" Foreground="White"/>
                                    <TextBlock Text="添加隧道"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <!-- Add Tunnel Form -->
                        <Border IsVisible="{Binding IsAddTunnelVisible}" 
                                Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16">
                            <StackPanel Spacing="12">
                                <TextBox Watermark="隧道名称" Text="{Binding NewTunnelName}" Classes="input"/>
                                <Grid ColumnDefinitions="*,12,*">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="本地端口" FontSize="11" 
                                                   Foreground="{DynamicResource TextTertiaryBrush}"/>
                                        <NumericUpDown Value="{Binding NewTunnelLocalPort}" 
                                                      Minimum="1" Maximum="65535"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2" Spacing="4">
                                        <TextBlock Text="远程端口" FontSize="11" 
                                                   Foreground="{DynamicResource TextTertiaryBrush}"/>
                                        <NumericUpDown Value="{Binding NewTunnelRemotePort}"
                                                      Minimum="1" Maximum="65535"/>
                                    </StackPanel>
                                </Grid>
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <Button Content="添加" Command="{Binding AddTunnelCommand}" Classes="accent"/>
                                    <Button Content="取消" Command="{Binding CancelAddTunnelCommand}" Classes="subtle"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Tunnel List -->
                        <ItemsControl ItemsSource="{Binding Tunnels}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16" Margin="0,0,0,8">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <PathIcon Data="{StaticResource PlugConnectedIcon}" Width="20" Height="20"
                                                      Foreground="{DynamicResource AccentBrush}"
                                                      VerticalAlignment="Center"/>
                                            <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Name}" FontWeight="Medium"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock FontSize="12" Foreground="{DynamicResource TextTertiaryBrush}">
                                                    <Run Text="本地:"/><Run Text="{Binding LocalPort}"/>
                                                    <Run Text=" → 远程:"/><Run Text="{Binding RemotePort}"/>
                                                </TextBlock>
                                            </StackPanel>
                                            <Button Grid.Column="2" 
                                                    Command="{Binding $parent[ItemsControl].((vm:FRPViewModel)DataContext).RemoveTunnelCommand}"
                                                    CommandParameter="{Binding}"
                                                    Classes="subtle" Height="28" Padding="8,0"
                                                    ToolTip.Tip="删除">
                                                <PathIcon Data="{StaticResource DeleteIcon}" Width="14" Height="14"/>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
