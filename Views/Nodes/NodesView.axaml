<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Lattice.ViewModels"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Avalonia;assembly=LiveChartsCore.SkiaSharpView.Avalonia"
             x:Class="Lattice.Views.Nodes.NodesView"
             x:DataType="vm:NodesViewModel">
    
    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Padding="24,16" Background="{DynamicResource BackgroundBrush}">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <TextBlock Text="节点管理" Classes="title" VerticalAlignment="Center"/>
                <TextBlock Grid.Column="1" Text="管理远程节点，实现多机部署" 
                           Foreground="{DynamicResource TextTertiaryBrush}" 
                           VerticalAlignment="Center" Margin="16,0,0,0"/>
                <Button Grid.Column="2" Command="{Binding ShowAddCommand}" Classes="accent">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="{StaticResource AddIcon}" Width="16" Height="16" Foreground="White"/>
                        <TextBlock Text="添加节点"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1">
            <StackPanel Margin="24" Spacing="16">
                <!-- Loading -->
                <ProgressBar IsIndeterminate="True" IsVisible="{Binding IsLoading}" Height="2"/>
                
                <!-- Error -->
                <Border Background="{DynamicResource StatusErrorBrush}" CornerRadius="8" Padding="16,12"
                        IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding ErrorMessage}" Foreground="White"/>
                </Border>

                <!-- Add Node Form -->
                <Border Background="{DynamicResource CardBrush}" CornerRadius="8" Padding="24"
                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                        IsVisible="{Binding ShowAddForm}">
                    <StackPanel Spacing="16">
                        <TextBlock Text="添加新节点" Classes="subtitle"/>
                        <TextBox Watermark="节点名称" Text="{Binding NewNodeName}" Classes="input"/>
                        <TextBox Watermark="WebSocket 地址 (例如: ws://192.168.1.100:3000)" 
                                 Text="{Binding NewNodeAddress}" Classes="input"/>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button Content="连接并添加" Command="{Binding AddNodeCommand}" Classes="accent"/>
                            <Button Content="取消" Command="{Binding CancelAddCommand}" Classes="subtle"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Empty State -->
                <StackPanel Spacing="12" HorizontalAlignment="Center" Margin="0,48,0,0"
                            IsVisible="{Binding !HasNodes}">
                    <PathIcon Data="{StaticResource CloudIcon}" Width="48" Height="48"
                              Foreground="{DynamicResource TextTertiaryBrush}" HorizontalAlignment="Center"/>
                    <TextBlock Text="暂无节点" Classes="body" HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextTertiaryBrush}"/>
                    <TextBlock Text="点击上方按钮添加您的第一个节点" 
                               Foreground="{DynamicResource TextTertiaryBrush}"
                               HorizontalAlignment="Center" FontSize="12"/>
                </StackPanel>

                <!-- Nodes Grid -->
                <ItemsControl ItemsSource="{Binding Nodes}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{DynamicResource CardBrush}" CornerRadius="8" 
                                    Width="280" Height="200" Margin="0,0,12,12"
                                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                                    Padding="16">
                                <Grid RowDefinitions="Auto,*,Auto">
                                    <!-- Header -->
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <Border Width="32" Height="32" CornerRadius="6"
                                                Background="{DynamicResource AccentSubtleBrush}">
                                            <PathIcon Data="{StaticResource ServerIcon}" Width="16" Height="16"
                                                      Foreground="{DynamicResource AccentBrush}"/>
                                        </Border>
                                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            <TextBlock Text="{Binding Address}" FontSize="11"
                                                       Foreground="{DynamicResource TextTertiaryBrush}"/>
                                        </StackPanel>
                                        <Border Grid.Column="2" CornerRadius="4" Padding="6,2"
                                                Background="{DynamicResource StatusRunningBrush}"
                                                IsVisible="{Binding IsOnline}">
                                            <TextBlock Text="在线" FontSize="10" Foreground="White"/>
                                        </Border>
                                        <Border Grid.Column="2" CornerRadius="4" Padding="6,2"
                                                Background="{DynamicResource StatusStoppedBrush}"
                                                IsVisible="{Binding !IsOnline}">
                                            <TextBlock Text="离线" FontSize="10" Foreground="White"/>
                                        </Border>
                                    </Grid>

                                    <!-- Charts -->
                                    <Grid Grid.Row="1" ColumnDefinitions="*,*" Margin="0,8,0,0">
                                        <StackPanel Spacing="4">
                                            <TextBlock Text="CPU" FontSize="10" 
                                                       Foreground="{DynamicResource TextTertiaryBrush}"/>
                                            <lvc:CartesianChart Series="{Binding CpuSeries}" 
                                                               Height="60" Background="Transparent"/>
                                            <TextBlock Text="{Binding CpuUsage, StringFormat={}{0:F1}%}" 
                                                       FontSize="12" FontWeight="Medium"
                                                       Foreground="{DynamicResource AccentBrush}"
                                                       HorizontalAlignment="Center"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <TextBlock Text="内存" FontSize="10" 
                                                       Foreground="{DynamicResource TextTertiaryBrush}"/>
                                            <lvc:CartesianChart Series="{Binding MemorySeries}" 
                                                               Height="60" Background="Transparent"/>
                                            <TextBlock Text="{Binding MemoryUsage, StringFormat={}{0:F1}%}" 
                                                       FontSize="12" FontWeight="Medium"
                                                       Foreground="{DynamicResource StatusRunningBrush}"
                                                       HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>

                                    <!-- Footer -->
                                    <Grid Grid.Row="2" ColumnDefinitions="*,Auto" Margin="0,8,0,0">
                                        <TextBlock Text="{Binding ServerCount, StringFormat={}{0} 个实例}"
                                                   FontSize="11" Foreground="{DynamicResource TextTertiaryBrush}"
                                                   VerticalAlignment="Center"/>
                                        <Button Grid.Column="1" Classes="subtle" Padding="8,4" FontSize="11"
                                                Command="{Binding $parent[ItemsControl].((vm:NodesViewModel)DataContext).RemoveNodeCommand}"
                                                CommandParameter="{Binding}">
                                            <PathIcon Data="{StaticResource DeleteIcon}" Width="14" Height="14"/>
                                        </Button>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
